<!DOCTYPE html>
<html lang="sq">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV Player - Pa CORS Probleme</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        
        header { 
            background: rgba(0, 0, 0, 0.3); 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px;
            text-align: center;
        }
        h1 { color: #00ff88; margin-bottom: 10px; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 10px;
        }
        .tab {
            padding: 10px 20px;
            background: #333;
            border-radius: 5px;
            cursor: pointer;
        }
        .tab.active {
            background: #00ff88;
            color: black;
        }
        .tab-content {
            display: none;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .tab-content.active {
            display: block;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: white;
        }
        button {
            background: #00ff88;
            color: black;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
        }
        button:hover { background: #00cc6a; }
        
        .player-container {
            background: black;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
            height: 400px;
        }
        #video-player {
            width: 100%;
            height: 100%;
        }
        .channel-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .content {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            height: 500px;
        }
        @media (max-width: 768px) {
            .content { grid-template-columns: 1fr; height: auto; }
        }
        
        .categories {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
        }
        .channels {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }
        
        .cat-item, .channel-item {
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 5px;
        }
        .cat-item:hover, .channel-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .cat-item.active, .channel-item.active {
            background: #00ff88;
            color: black;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            display: none;
        }
        .status.success {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            display: block;
        }
        .status.error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff4444;
            display: block;
        }
        .status.loading {
            background: rgba(0, 150, 255, 0.2);
            border: 1px solid #0096ff;
            display: block;
        }
        
        .local-file {
            background: rgba(0, 150, 255, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üì∫ IPTV Player - Version Pa CORS</h1>
            <p>Punon me √ßdo playlist M3U lokale ose online</p>
        </header>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('m3u-tab')">M3U Playlist</div>
            <div class="tab" onclick="showTab('xtream-tab')">Xtream Codes</div>
            <div class="tab" onclick="showTab('local-tab')">Skedar Lokal</div>
        </div>
        
        <!-- M3U Tab -->
        <div id="m3u-tab" class="tab-content active">
            <h3>üîó Ngarko M3U nga URL</h3>
            <input type="text" id="m3u-url" placeholder="https://example.com/playlist.m3u">
            <button onclick="loadM3UFromURL()">Ngarko M3U</button>
            
            <div class="local-file">
                <h3>üìÅ Ngarko M3U nga skedar lokal</h3>
                <input type="file" id="m3u-file" accept=".m3u,.txt">
                <button onclick="loadM3UFromFile()">Ngarko Skedarin</button>
            </div>
            
            <div class="status" id="m3u-status"></div>
        </div>
        
        <!-- Xtream Tab -->
        <div id="xtream-tab" class="tab-content">
            <h3>üîë Xtream Codes API</h3>
            <p style="color: #ff9900; margin-bottom: 15px;">
                ‚ö†Ô∏è Sh√´nim: Xtream Codes k√´rkon CORS proxy p√´r t√´ punuar n√´ browser.
                P√´rdorni M3U ose skedar lokal p√´r testim.
            </p>
            <input type="text" id="xtream-server" placeholder="http://server.com:8080">
            <input type="text" id="xtream-user" placeholder="P√´rdoruesi">
            <input type="text" id="xtream-pass" placeholder="Fjal√´kalimi">
            <button onclick="loginXtream()">Ky√ßu Xtream</button>
            <div class="status" id="xtream-status"></div>
        </div>
        
        <!-- Local Tab -->
        <div id="local-tab" class="tab-content">
            <h3>üíæ Skedar Lokal i Thjesht√´</h3>
            <p>Krijo nj√´ skedar .m3u n√´ Notepad me k√´t√´ format:</p>
            <textarea id="m3u-example" rows="10" style="width:100%;background:#222;color:#fff;padding:10px;border-radius:5px;margin:10px 0;">
#EXTM3U
#EXTINF:-1 tvg-id="RTSH1.al" tvg-name="RTSH 1" tvg-logo="https://example.com/rtsh1.png" group-title="Shqip√´ri",RTSH 1
http://example.com/rtsh1.m3u8

#EXTINF:-1 tvg-id="RTSH2.al" tvg-name="RTSH 2" tvg-logo="https://example.com/rtsh2.png" group-title="Shqip√´ri",RTSH 2
http://example.com/rtsh2.m3u8

#EXTINF:-1 tvg-id="TopChannel.al" tvg-name="Top Channel" tvg-logo="https://example.com/top.png" group-title="Shqip√´ri",Top Channel
http://example.com/top.m3u8
            </textarea>
            <button onclick="useExample()">P√´rdor Shembull</button>
            <div class="status" id="local-status"></div>
        </div>
        
        <div class="player-container">
            <video id="video-player" controls playsinline>
                Shfletuesi juaj nuk mb√´shtet HTML5 video.
            </video>
            <div class="channel-info" id="channel-info">Zgjidhni nj√´ kanal p√´r t√´ luajtur</div>
        </div>
        
        <div class="content">
            <div class="categories">
                <h3>üìÇ Kategorit√´</h3>
                <div id="categories-list">
                    <div class="cat-item active" onclick="showAllChannels()">T√´ Gjitha</div>
                </div>
            </div>
            
            <div class="channels" id="channels-list">
                <div style="text-align:center;padding:50px;">
                    üëÜ Zgjidhni nj√´ metod√´ p√´r t√´ ngarkuar kanalet
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== KONFIGURIMI ==========
        const config = {
            useCorsProxy: false, // Vendose true n√´se d√´shiron t√´ p√´rdor√´sh proxy
            corsProxy: 'https://cors-anywhere.herokuapp.com/', // Proxy URL
            testM3U: 'https://iptv-org.github.io/iptv/countries/al.m3u'
        };

        // ========== VARIABLA ==========
        let channels = [];
        let categories = [];
        let currentChannel = null;
        let hlsPlayer = null;
        let currentCategory = 'all';

        // ========== FUNKSIONET P√ãR TAB ==========
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // ========== M3U FUNKSIONE ==========
        async function loadM3UFromURL() {
            const url = document.getElementById('m3u-url').value.trim();
            if (!url) {
                showStatus('m3u-status', 'Ju lutem shkruani nj√´ URL', 'error');
                return;
            }

            try {
                showStatus('m3u-status', 'Duke ngarkuar playlist...', 'loading');
                
                let fetchUrl = url;
                if (config.useCorsProxy) {
                    fetchUrl = config.corsProxy + url;
                }
                
                const response = await fetch(fetchUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const text = await response.text();
                processM3UData(text);
                showStatus('m3u-status', `‚úÖ U ngarkuan ${channels.length} kanale`, 'success');
                
            } catch (error) {
                showStatus('m3u-status', `‚ùå Gabim: ${error.message}`, 'error');
                console.error('M3U Error:', error);
                
                // Provo t√´ ngarkosh shembullin n√´se d√´shton
                if (confirm('D√´shtoi ngarkimi. D√´shironi t√´ ngarkoni shembull t√´ playlist-it?')) {
                    loadExampleM3U();
                }
            }
        }

        function loadM3UFromFile() {
            const fileInput = document.getElementById('m3u-file');
            if (!fileInput.files.length) {
                showStatus('m3u-status', 'Ju lutem zgjidhni nj√´ skedar', 'error');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    showStatus('m3u-status', 'Duke procesuar skedarin...', 'loading');
                    processM3UData(e.target.result);
                    showStatus('m3u-status', `‚úÖ U ngarkuan ${channels.length} kanale nga skedari`, 'success');
                } catch (error) {
                    showStatus('m3u-status', `‚ùå Gabim n√´ procesim: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = function() {
                showStatus('m3u-status', '‚ùå Gabim n√´ leximin e skedarit', 'error');
            };
            
            reader.readAsText(file);
        }

        function loadExampleM3U() {
            showStatus('m3u-status', 'Duke ngarkuar shembull...', 'loading');
            
            // Shembull i thjesht√´ p√´r testim
            const exampleM3U = `#EXTM3U
#EXTINF:-1 tvg-id="test1" tvg-name="Test Channel 1" tvg-logo="https://img.icons8.com/color/48/000000/tv.png" group-title="Test",Test Channel 1
https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8

#EXTINF:-1 tvg-id="test2" tvg-name="Test Channel 2" tvg-logo="https://img.icons8.com/color/48/000000/television.png" group-title="Test",Test Channel 2
https://test-streams.mux.dev/x36xhzz/url_2/193039199_mp4_h264_aac_hd_7.m3u8

#EXTINF:-1 tvg-id="test3" tvg-name="Test Channel 3" tvg-logo="https://img.icons8.com/color/48/000000/live-tv.png" group-title="Shqip√´ri",Test Channel 3
https://test-streams.mux.dev/x36xhzz/url_3/193039199_mp4_h264_aac_hd_7.m3u8`;
            
            processM3UData(exampleM3U);
            showStatus('m3u-status', '‚úÖ U ngarkuan 3 kanale test', 'success');
        }

        function useExample() {
            const exampleText = document.getElementById('m3u-example').value;
            processM3UData(exampleText);
            showStatus('local-status', '‚úÖ U ngarkua shembulli. Ju lutem p√´rdorni linke t√´ v√´rteta p√´r streaming.', 'success');
            showTab('m3u-tab');
        }

        function processM3UData(data) {
            try {
                channels = parseM3U(data);
                
                if (channels.length === 0) {
                    throw new Error('Nuk u gjet√´n kanale n√´ playlist');
                }
                
                updateCategories();
                renderChannels();
                showTab('m3u-tab');
                
            } catch (error) {
                showStatus('m3u-status', `‚ùå Gabim n√´ procesim: ${error.message}`, 'error');
            }
        }

        function parseM3U(data) {
            const channels = [];
            const lines = data.split('\n');
            let currentChannel = null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('#EXTINF:')) {
                    currentChannel = {
                        id: Date.now() + i,
                        name: line.split(',').pop().trim(),
                        category: (line.match(/group-title="([^"]+)"/) || [])[1] || 'Other',
                        logo: (line.match(/tvg-logo="([^"]+)"/) || [])[1] || '',
                        url: '',
                        tvgId: (line.match(/tvg-id="([^"]+)"/) || [])[1] || ''
                    };
                } else if (currentChannel && line && !line.startsWith('#') && line !== '') {
                    currentChannel.url = line;
                    channels.push({...currentChannel});
                    currentChannel = null;
                }
            }

            return channels;
        }

        // ========== XTREAM FUNKSIONE (me proxy) ==========
        async function loginXtream() {
            const server = document.getElementById('xtream-server').value.trim();
            const username = document.getElementById('xtream-user').value.trim();
            const password = document.getElementById('xtream-pass').value.trim();

            if (!server || !username || !password) {
                showStatus('xtream-status', 'Ju lutem plot√´soni t√´ gjitha fushat', 'error');
                return;
            }

            try {
                showStatus('xtream-status', 'Duke u ky√ßur n√´ server...', 'loading');
                
                // P√´rdor proxy p√´r CORS
                let apiUrl = `${server}/player_api.php?username=${username}&password=${password}&action=get_live_categories`;
                if (config.useCorsProxy) {
                    apiUrl = config.corsProxy + apiUrl;
                }
                
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`Serveri nuk u p√´rgjigj: ${response.status}`);
                
                const data = await response.json();
                console.log('Xtream response:', data);
                
                // P√´r serveret q√´ kthejn√´ t√´ dh√´na t√´ ndryshme
                if (data.user_info && data.user_info.status === 'Active') {
                    showStatus('xtream-status', '‚úÖ Ky√ßja u krye me sukses', 'success');
                    // Merr kanalet
                    await loadXtreamChannels('all');
                } else {
                    throw new Error('Kredenciale t√´ pavlefshme ose llogari joaktive');
                }
                
            } catch (error) {
                showStatus('xtream-status', `‚ùå Gabim Xtream: ${error.message}`, 'error');
                console.error('Xtream Error:', error);
                
                // Sugjero p√´rdorimin e M3U
                if (confirm('Xtream nuk funksionon p√´r shkak t√´ CORS. D√´shironi t√´ kaloni n√´ M3U?')) {
                    showTab('m3u-tab');
                }
            }
        }

        // ========== UI FUNKSIONE ==========
        function updateCategories() {
            const container = document.getElementById('categories-list');
            container.innerHTML = '<div class="cat-item active" onclick="showAllChannels()">T√´ Gjitha</div>';
            
            // Merr kategorit√´ unike
            const uniqueCats = [...new Set(channels.map(c => c.category).filter(c => c))];
            
            uniqueCats.forEach(category => {
                const div = document.createElement('div');
                div.className = 'cat-item';
                div.textContent = category || 'Pa Kategori';
                div.onclick = () => filterByCategory(category);
                container.appendChild(div);
            });
        }

        function showAllChannels() {
            currentCategory = 'all';
            document.querySelectorAll('.cat-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector('.cat-item').classList.add('active');
            renderChannels();
        }

        function filterByCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.cat-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const filtered = category === 'all' 
                ? channels 
                : channels.filter(c => c.category === category);
            
            renderChannels(filtered);
        }

        function renderChannels(channelList = channels) {
            const container = document.getElementById('channels-list');
            
            if (!channelList || channelList.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:50px;color:#ff9900;">Nuk u gjet√´n kanale</div>';
                return;
            }
            
            container.innerHTML = '';
            
            channelList.forEach(channel => {
                const div = document.createElement('div');
                div.className = 'channel-item';
                if (currentChannel && currentChannel.id === channel.id) {
                    div.classList.add('active');
                }
                
                div.innerHTML = `
                    <div style="display:flex;align-items:center;gap:10px;">
                        ${channel.logo ? `<img src="${channel.logo}" style="width:30px;height:30px;border-radius:50%;" onerror="this.src='https://img.icons8.com/color/48/000000/tv.png'">` : ''}
                        <strong>${channel.name}</strong>
                    </div>
                    <small style="color:#aaa;display:block;margin-top:5px;">${channel.category || ''}</small>
                `;
                
                div.onclick = () => playChannel(channel);
                container.appendChild(div);
            });
        }

        // ========== PLAYER FUNKSIONE ==========
        function playChannel(channel) {
            currentChannel = channel;
            
            // P√´rdit√´so UI
            document.querySelectorAll('.channel-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // P√´rdit√´so informacionin
            document.getElementById('channel-info').textContent = 
                `üé¨ ${channel.name} | üìÇ ${channel.category || 'Pa Kategori'}`;
            
            // Luaj kanalin
            playStream(channel.url);
        }

        function playStream(url) {
            const videoPlayer = document.getElementById('video-player');
            
            // Stop player ekzistues
            if (hlsPlayer) {
                hlsPlayer.destroy();
                hlsPlayer = null;
            }
            
            videoPlayer.pause();
            videoPlayer.src = '';
            
            // Kontrollo n√´se √´sht√´ URL e vlefshme
            if (!url || !url.startsWith('http')) {
                showStatus('m3u-status', '‚ùå URL e pavlefshme p√´r streaming', 'error');
                return;
            }
            
            // Kontrollo p√´r HLS
            if (url.includes('.m3u8')) {
                if (typeof Hls !== 'undefined' && Hls.isSupported()) {
                    hlsPlayer = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 90
                    });
                    
                    hlsPlayer.loadSource(url);
                    hlsPlayer.attachMedia(videoPlayer);
                    
                    hlsPlayer.on(Hls.Events.MANIFEST_PARSED, () => {
                        videoPlayer.play().catch(e => {
                            console.warn('Auto-play failed:', e);
                            // L√´r√´ p√´rdoruesin t√´ klikoj√´ manualisht
                        });
                    });
                    
                    hlsPlayer.on(Hls.Events.ERROR, (event, data) => {
                        console.error('HLS error:', data);
                        if (data.fatal) {
                            showStatus('m3u-status', '‚ùå Gabim n√´ streaming. Duke provuar alternativ√´...', 'error');
                        }
                    });
                    
                } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                    // Safari
                    videoPlayer.src = url;
                    videoPlayer.play().catch(e => {
                        console.warn('Safari play failed:', e);
                    });
                } else {
                    showStatus('m3u-status', '‚ùå Shfletuesi nuk mb√´shtet HLS', 'error');
                }
            } else {
                // Video t√´ thjeshta (MP4, etc)
                videoPlayer.src = url;
                videoPlayer.play().catch(e => {
                    console.warn('Direct play failed:', e);
                });
            }
        }

        // ========== HELPERS ==========
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = 'status ' + type;
            
            if (type !== 'loading') {
                setTimeout(() => {
                    element.className = 'status';
                }, 5000);
            }
        }

        // ========== INICIALIZIMI ==========
        window.onload = function() {
            // Ngarko HLS.js
            if (typeof Hls === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/hls.js@latest';
                document.head.appendChild(script);
            }
            
            // Test URL e paracaktuar
            document.getElementById('m3u-url').value = config.testM3U;
            
            // Shto buton test t√´ shpejt√´
            const testBtn = document.createElement('button');
            testBtn.textContent = 'üî¨ Test me Kanale Demo';
            testBtn.style.background = '#0096ff';
            testBtn.style.marginTop = '10px';
            testBtn.onclick = loadExampleM3U;
            document.getElementById('m3u-tab').appendChild(testBtn);
            
            console.log('IPTV Player u inicializua me sukses');
        };

        // ========== EKSPORT FUNKSIONESH GLOBALE ==========
        window.loadM3UFromURL = loadM3UFromURL;
        window.loadM3UFromFile = loadM3UFromFile;
        window.loginXtream = loginXtream;
        window.useExample = useExample;
        window.showAllChannels = showAllChannels;
        window.filterByCategory = filterByCategory;
        window.playChannel = playChannel;
        window.showTab = showTab;
    </script>
</body>
</html>
